<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>DeChat ‚Äì Secure P2P Chat</title>
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
:root {
  --bg: #0a1628;
  --bg2: #111e30;
  --surface: #1a2a3e;
  --surface2: #243548;
  --border: #2a3e56;
  --accent: #3b82f6;
  --accent2: #2563eb;
  --accent3: #60a5fa;
  --text: #e2eaf4;
  --text2: #8ba4c0;
  --me: #2563eb;
  --them: #1a2a3e;
  --success: #10b981;
  --danger: #ef4444;
  --warn: #f59e0b;
  --radius: 14px;
}
[data-theme=light]{
  --bg:#f0f4f8;--bg2:#ffffff;--surface:#ffffff;--surface2:#e8eef6;
  --border:#d1dce8;--text:#0f1f35;--text2:#5a7490;--them:#e8eef6;
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
body{font-family:'Segoe UI',system-ui,sans-serif;background:var(--bg);color:var(--text);height:100dvh;display:flex;flex-direction:column;overflow:hidden}

/* ‚îÄ‚îÄ‚îÄ SETUP SCREEN ‚îÄ‚îÄ‚îÄ */
#screen-setup{
  position:fixed;inset:0;z-index:100;
  background:linear-gradient(145deg,#0a1628 0%,#1a3a6e 50%,#0a1628 100%);
  display:flex;align-items:center;justify-content:center;padding:20px;
}
.setup-card{
  background:rgba(26,42,62,0.95);border:1px solid var(--border);
  border-radius:24px;width:100%;max-width:400px;padding:36px 28px;
  box-shadow:0 24px 64px rgba(0,0,0,0.5);backdrop-filter:blur(12px);
}
.setup-logo{font-size:2.2rem;font-weight:800;color:var(--accent3);letter-spacing:-1px;text-align:center;margin-bottom:4px}
.setup-sub{text-align:center;color:var(--text2);font-size:.85rem;margin-bottom:28px}
.field{margin-bottom:14px}
.field label{display:block;font-size:.75rem;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px}
.field input{
  width:100%;padding:13px 16px;background:var(--surface2);
  border:1.5px solid var(--border);border-radius:12px;color:var(--text);
  font-size:.95rem;outline:none;transition:border-color .2s;
}
.field input:focus{border-color:var(--accent)}
.field input::placeholder{color:var(--text2)}
.btn-row{display:flex;gap:10px;margin-top:20px}
.btn{
  flex:1;padding:14px;border:none;border-radius:12px;
  font-size:.9rem;font-weight:700;cursor:pointer;
  display:flex;align-items:center;justify-content:center;gap:8px;
  transition:all .2s;letter-spacing:.3px;
}
.btn-primary{background:var(--accent);color:#fff}
.btn-primary:hover{background:var(--accent2);transform:translateY(-1px)}
.btn-secondary{background:var(--surface2);color:var(--text);border:1.5px solid var(--border)}
.btn-secondary:hover{background:var(--border)}
.setup-divider{display:flex;align-items:center;gap:10px;margin:18px 0;color:var(--text2);font-size:.8rem}
.setup-divider::before,.setup-divider::after{content:'';flex:1;height:1px;background:var(--border)}
.avatar-preview{width:48px;height:48px;border-radius:50%;object-fit:cover;border:2px solid var(--accent)}

/* ‚îÄ‚îÄ‚îÄ MAIN LAYOUT ‚îÄ‚îÄ‚îÄ */
#screen-chat{display:none;flex:1;flex-direction:column;overflow:hidden}

/* Header */
.header{
  background:var(--bg2);border-bottom:1px solid var(--border);
  padding:10px 14px;display:flex;align-items:center;gap:12px;
  height:60px;flex-shrink:0;z-index:10;
}
.header-avatar{width:38px;height:38px;border-radius:50%;object-fit:cover;cursor:pointer;flex-shrink:0}
.header-info{flex:1;overflow:hidden}
.header-title{font-size:.95rem;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.header-status{font-size:.7rem;color:var(--text2);display:flex;align-items:center;gap:5px}
.status-dot{width:6px;height:6px;border-radius:50%;background:var(--text2);flex-shrink:0}
.status-dot.on{background:var(--success)}
.header-actions{display:flex;gap:4px;align-items:center}
.icon-btn{width:36px;height:36px;border:none;background:none;color:var(--text2);cursor:pointer;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:1rem;transition:all .15s}
.icon-btn:hover{background:var(--surface2);color:var(--text)}
.reconnect-btn{background:var(--danger);color:#fff;border:none;padding:5px 10px;border-radius:6px;font-size:.7rem;font-weight:700;cursor:pointer;display:none}

/* Pinned */
.pinned-bar{
  background:var(--surface);border-bottom:1px solid var(--border);
  padding:8px 14px;display:none;align-items:center;gap:10px;cursor:pointer;
}
.pinned-bar:hover{background:var(--surface2)}
.pinned-bar i{color:var(--accent);font-size:.9rem}
.pinned-bar-text{flex:1;font-size:.8rem;color:var(--text2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

/* Chat Area */
#chat-area{
  flex:1;overflow-y:auto;padding:12px 14px;
  display:flex;flex-direction:column;gap:3px;
}
#chat-area::-webkit-scrollbar{width:4px}
#chat-area::-webkit-scrollbar-track{background:transparent}
#chat-area::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px}

/* Date Separator */
.date-sep{display:flex;align-items:center;justify-content:center;margin:12px 0 6px}
.date-sep span{
  background:var(--surface2);color:var(--text2);
  font-size:.7rem;font-weight:600;padding:4px 12px;
  border-radius:10px;letter-spacing:.3px;
}

/* Messages */
.msg-row{display:flex;width:100%;margin-bottom:1px}
.msg-row.me{justify-content:flex-end}
.msg-row.them{justify-content:flex-start}
.msg-row.sys{justify-content:center;margin:8px 0}
.bubble{
  max-width:78%;padding:9px 13px;border-radius:16px;
  font-size:.92rem;word-wrap:break-word;display:flex;
  flex-direction:column;position:relative;
  box-shadow:0 1px 3px rgba(0,0,0,.2);
}
.me .bubble{background:var(--me);color:#fff;border-bottom-right-radius:4px}
.them .bubble{background:var(--them);color:var(--text);border-bottom-left-radius:4px}
.sys .bubble{background:var(--surface2);color:var(--text2);font-size:.75rem;border-radius:12px;padding:5px 14px;text-align:center}
.bubble-sender{font-size:.72rem;font-weight:700;color:var(--accent3);margin-bottom:3px}
.bubble-meta{display:flex;align-items:center;justify-content:flex-end;gap:5px;margin-top:5px}
.bubble-time{font-size:.62rem;color:rgba(255,255,255,.6)}
.them .bubble-time{color:var(--text2)}
.msg-status{font-size:.7rem;color:rgba(255,255,255,.6)}
.msg-status.read{color:#93c5fd}
.bubble-actions{display:none;align-items:center;gap:2px;font-size:.7rem;color:rgba(255,255,255,.5)}
.them .bubble-actions{color:var(--text2)}
.bubble:hover .bubble-actions{display:flex}
.ba-btn{cursor:pointer;padding:2px 5px;border-radius:4px;transition:.15s}
.ba-btn:hover{background:rgba(255,255,255,.15);color:#fff}

/* Reply preview */
.reply-preview{
  background:rgba(0,0,0,.2);border-left:3px solid var(--accent3);
  border-radius:6px;padding:5px 8px;margin-bottom:6px;cursor:pointer;
  font-size:.78rem;
}
.reply-preview-name{color:var(--accent3);font-weight:700;font-size:.72rem;margin-bottom:2px}
.reply-preview-text{color:rgba(255,255,255,.7);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.them .reply-preview{background:rgba(0,0,0,.12)}
.them .reply-preview-text{color:var(--text2)}

/* Edited label */
.edited-label{font-size:.6rem;color:rgba(255,255,255,.5);font-style:italic}
.them .edited-label{color:var(--text2)}

/* Reactions */
.reactions{display:flex;gap:3px;flex-wrap:wrap;margin-top:4px}
.reaction{
  background:rgba(0,0,0,.2);border:1px solid rgba(255,255,255,.15);
  border-radius:10px;padding:2px 7px;font-size:.75rem;
  display:flex;align-items:center;gap:3px;cursor:pointer;transition:.15s;
}
.reaction:hover{background:var(--accent);border-color:var(--accent)}

/* Media */
.chat-img{max-width:100%;max-height:260px;border-radius:8px;margin-top:4px;cursor:pointer;display:block}
.chat-file{
  display:flex;align-items:center;gap:10px;padding:10px;
  background:rgba(0,0,0,.2);border-radius:8px;margin-top:4px;
  text-decoration:none;color:inherit;border:1px solid rgba(255,255,255,.1);
}
.them .chat-file{background:rgba(0,0,0,.08);border-color:var(--border)}
.chat-voice{display:flex;align-items:center;gap:10px;padding:8px;background:rgba(0,0,0,.2);border-radius:20px;margin-top:4px}
.them .chat-voice{background:rgba(0,0,0,.08)}
.voice-play{width:30px;height:30px;border-radius:50%;background:rgba(255,255,255,.25);color:#fff;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.voice-waveform{flex:1;height:28px;display:flex;align-items:center;gap:2px}
.voice-bar{width:3px;background:rgba(255,255,255,.4);border-radius:2px}
.them .voice-bar{background:var(--text2)}
.voice-dur{font-size:.72rem;color:rgba(255,255,255,.7);flex-shrink:0}
.them .voice-dur{color:var(--text2)}

/* Scroll btn */
.scroll-btn{
  position:absolute;bottom:80px;right:14px;
  width:38px;height:38px;border-radius:50%;
  background:var(--surface2);border:1px solid var(--border);
  color:var(--text);cursor:pointer;display:none;
  align-items:center;justify-content:center;font-size:.9rem;
  box-shadow:0 2px 8px rgba(0,0,0,.3);z-index:5;
}

/* Reply bar */
.reply-bar{
  background:var(--surface);border-top:1px solid var(--border);
  padding:8px 14px;display:none;align-items:center;gap:10px;
}
.reply-bar-content{flex:1;font-size:.8rem;border-left:3px solid var(--accent);padding-left:8px;overflow:hidden}
.reply-bar-name{color:var(--accent3);font-weight:700;font-size:.75rem}
.reply-bar-text{color:var(--text2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:.8rem}
.reply-bar-close{color:var(--text2);cursor:pointer;padding:4px;font-size:1rem}
.reply-bar-close:hover{color:var(--text)}

/* Footer */
.footer{background:var(--bg2);border-top:1px solid var(--border);padding:10px 12px;flex-shrink:0}
.footer-main{display:flex;align-items:center;gap:8px}
.input-box{
  flex:1;background:var(--surface2);border:1.5px solid var(--border);
  border-radius:22px;padding:10px 16px;color:var(--text);
  font-size:.9rem;outline:none;resize:none;max-height:120px;
  transition:border-color .2s;font-family:inherit;
}
.input-box:focus{border-color:var(--accent)}
.input-box::placeholder{color:var(--text2)}
.send-btn{
  width:40px;height:40px;border-radius:50%;background:var(--accent);
  color:#fff;border:none;cursor:pointer;display:none;
  align-items:center;justify-content:center;font-size:.95rem;
  flex-shrink:0;transition:all .2s;
}
.send-btn:hover{background:var(--accent2);transform:scale(1.05)}
.send-btn.show{display:flex}

/* Voice recording UI */
.voice-rec{display:none;align-items:center;gap:12px;padding:4px 0}
.voice-rec.active{display:flex}
.rec-dot{width:10px;height:10px;border-radius:50%;background:var(--danger);animation:blink 1s infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}
.rec-time{font-size:.9rem;color:var(--text);font-variant-numeric:tabular-nums;min-width:40px}
.rec-cancel{background:var(--surface2);color:var(--text);border:1.5px solid var(--border);padding:8px 14px;border-radius:20px;cursor:pointer;font-size:.8rem;font-weight:600}
.rec-send{background:var(--success);color:#fff;border:none;padding:8px 14px;border-radius:20px;cursor:pointer;font-size:.8rem;font-weight:600}

/* Emoji picker */
.emoji-picker{
  position:absolute;bottom:65px;left:50%;transform:translateX(-50%);
  background:var(--surface);border:1px solid var(--border);
  border-radius:16px;padding:10px;display:none;
  box-shadow:0 8px 32px rgba(0,0,0,.4);z-index:50;
  max-width:calc(100vw - 28px);
}
.emoji-grid{display:flex;flex-wrap:wrap;gap:4px;max-height:180px;overflow-y:auto;max-width:300px}
.emoji-item{width:36px;height:36px;display:flex;align-items:center;justify-content:center;font-size:1.3rem;cursor:pointer;border-radius:8px;transition:.1s}
.emoji-item:hover{background:var(--surface2)}

/* Context menu */
.ctx-menu{
  position:fixed;background:var(--surface);border:1px solid var(--border);
  border-radius:12px;padding:6px;display:none;
  box-shadow:0 8px 32px rgba(0,0,0,.4);z-index:200;min-width:160px;
}
.ctx-item{display:flex;align-items:center;gap:10px;padding:10px 12px;cursor:pointer;border-radius:8px;font-size:.88rem;color:var(--text)}
.ctx-item:hover{background:var(--surface2)}
.ctx-item.danger{color:var(--danger)}
.ctx-item i{width:16px;text-align:center;color:var(--text2)}
.ctx-item.danger i{color:var(--danger)}

/* Modals */
.modal{
  position:fixed;inset:0;z-index:300;
  background:rgba(0,0,0,.6);display:none;
  align-items:flex-end;justify-content:center;
  backdrop-filter:blur(4px);
}
.modal.show{display:flex}
.modal-sheet{
  background:var(--surface);border-radius:20px 20px 0 0;
  width:100%;max-width:500px;max-height:80dvh;
  overflow-y:auto;padding:20px;
}
.modal-center{
  background:var(--surface);border-radius:20px;
  width:calc(100% - 40px);max-width:400px;padding:24px;
}
.modal-handle{width:40px;height:4px;background:var(--border);border-radius:2px;margin:0 auto 16px}
.modal-title{font-size:1rem;font-weight:700;margin-bottom:16px;text-align:center}
.modal-close{float:right;background:none;border:none;color:var(--text2);cursor:pointer;font-size:1.2rem;padding:2px 6px;border-radius:6px}
.modal-close:hover{background:var(--surface2);color:var(--text)}
.modal-item{display:flex;align-items:center;gap:12px;padding:14px 0;border-bottom:1px solid var(--border);cursor:pointer}
.modal-item:last-child{border-bottom:none}
.modal-item:hover{opacity:.8}
.modal-item i{width:36px;height:36px;background:var(--surface2);border-radius:10px;display:flex;align-items:center;justify-content:center;color:var(--accent);font-size:1rem}
.toggle-row{display:flex;align-items:center;justify-content:space-between;padding:12px 0;border-bottom:1px solid var(--border)}
.toggle-row:last-child{border-bottom:none}
.toggle-label{display:flex;align-items:center;gap:10px;font-size:.9rem}
.toggle-label i{color:var(--accent)}
.toggle{position:relative;width:42px;height:24px;flex-shrink:0}
.toggle input{opacity:0;width:0;height:0}
.toggle-slider{position:absolute;inset:0;background:var(--border);border-radius:12px;transition:.3s;cursor:pointer}
.toggle-slider:before{content:'';position:absolute;width:18px;height:18px;border-radius:50%;background:#fff;bottom:3px;left:3px;transition:.3s}
.toggle input:checked+.toggle-slider{background:var(--accent)}
.toggle input:checked+.toggle-slider:before{transform:translateX(18px)}

/* Loading overlay */
.loading{
  position:fixed;inset:0;z-index:500;
  background:rgba(10,22,40,.85);display:none;
  align-items:center;justify-content:center;flex-direction:column;gap:14px;
  backdrop-filter:blur(6px);
}
.loading.show{display:flex}
.spinner{width:40px;height:40px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-text{color:var(--text2);font-size:.9rem}

/* Toast */
.toast{
  position:fixed;bottom:76px;left:50%;transform:translateX(-50%);
  background:var(--surface);border:1px solid var(--border);
  color:var(--text);padding:9px 18px;border-radius:20px;
  font-size:.8rem;z-index:400;display:none;
  box-shadow:0 4px 16px rgba(0,0,0,.3);white-space:nowrap;
  animation:fadeup .25s ease;
}
@keyframes fadeup{from{opacity:0;transform:translateX(-50%) translateY(8px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}

/* QR */
#qrcode-wrap img,#qrcode-wrap canvas{width:180px!important;height:180px!important}

/* Member list */
.member-item{display:flex;align-items:center;gap:12px;padding:10px 0;border-bottom:1px solid var(--border)}
.member-item:last-child{border-bottom:none}
.member-avatar{width:36px;height:36px;border-radius:50%;object-fit:cover}
.member-name{font-size:.9rem;font-weight:600}
.member-tag{font-size:.72rem;color:var(--text2)}

/* Location */
.chat-location{display:flex;align-items:center;gap:10px;padding:10px;background:rgba(0,0,0,.2);border-radius:8px;margin-top:4px;text-decoration:none;color:inherit;border:1px solid rgba(255,255,255,.1)}
.them .chat-location{background:rgba(0,0,0,.08);border-color:var(--border)}

/* Image viewer */
.img-viewer{position:fixed;inset:0;z-index:600;background:rgba(0,0,0,.92);display:none;align-items:center;justify-content:center}
.img-viewer.show{display:flex}
.img-viewer img{max-width:95%;max-height:95dvh;border-radius:8px}
.img-viewer-close{position:absolute;top:16px;right:16px;background:rgba(255,255,255,.2);color:#fff;border:none;width:40px;height:40px;border-radius:50%;cursor:pointer;font-size:1.3rem}

@media (max-width:400px){.bubble{max-width:88%}}
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê SETUP SCREEN ‚ïê‚ïê‚ïê -->
<div id="screen-setup">
  <div class="setup-card">
    <div style="display:flex;align-items:center;justify-content:center;gap:14px;margin-bottom:6px">
      <img id="setup-avatar" class="avatar-preview" src="" alt="">
      <div class="setup-logo">DeChat</div>
    </div>
    <div class="setup-sub">Secure ¬∑ Peer-to-Peer ¬∑ Encrypted</div>

    <div class="field">
      <label>Username</label>
      <input id="inp-name" placeholder="Nama kamu..." oninput="updateSetupAvatar()" maxlength="30" autocomplete="off">
    </div>
    <div class="field">
      <label>Room ID</label>
      <input id="inp-room" placeholder="Nama room..." maxlength="40" autocomplete="off">
    </div>
    <div class="field">
      <label>Password Room (opsional)</label>
      <input id="inp-pass" type="password" placeholder="Kosongkan jika tidak ada..." maxlength="50">
    </div>

    <div class="btn-row">
      <button class="btn btn-primary" onclick="startApp(true)"><i class="fas fa-plus"></i> Buat Room</button>
      <button class="btn btn-secondary" onclick="startApp(false)"><i class="fas fa-sign-in-alt"></i> Gabung</button>
    </div>

    <div class="setup-divider">atau scan QR</div>
    <button class="btn btn-secondary" onclick="openScanner()" style="margin-top:0"><i class="fas fa-qrcode"></i> Scan QR Code</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê MAIN CHAT ‚ïê‚ïê‚ïê -->
<div id="screen-chat">

  <!-- Header -->
  <div class="header">
    <img id="hdr-avatar" class="header-avatar" src="" alt="" onclick="openModal('modal-members')">
    <div class="header-info">
      <div class="header-title" id="hdr-title">DeChat</div>
      <div class="header-status">
        <div class="status-dot" id="status-dot"></div>
        <span id="status-text">Menghubungkan...</span>
      </div>
    </div>
    <div class="header-actions">
      <button class="reconnect-btn" id="reconnect-btn" onclick="manualReconnect()">RECONNECT</button>
      <button class="icon-btn" onclick="openModal('modal-info')" title="Info Room"><i class="fas fa-info-circle"></i></button>
      <button class="icon-btn" onclick="toggleTheme()" title="Tema"><i class="fas fa-moon" id="theme-icon"></i></button>
      <button class="icon-btn" onclick="openModal('modal-settings')" title="Pengaturan"><i class="fas fa-cog"></i></button>
    </div>
  </div>

  <!-- Pinned -->
  <div class="pinned-bar" id="pinned-bar" onclick="scrollToPinned()">
    <i class="fas fa-thumbtack"></i>
    <div class="pinned-bar-text" id="pinned-bar-text"></div>
    <i class="fas fa-times" onclick="event.stopPropagation();unpinAll()" style="color:var(--text2);font-size:.9rem"></i>
  </div>

  <!-- Chat -->
  <div id="chat-area" onscroll="onScroll()"></div>
  <button class="scroll-btn" id="scroll-btn" onclick="scrollToBottom()"><i class="fas fa-chevron-down"></i></button>

  <!-- Reply bar -->
  <div class="reply-bar" id="reply-bar">
    <div class="reply-bar-content">
      <div class="reply-bar-name" id="reply-bar-name"></div>
      <div class="reply-bar-text" id="reply-bar-text"></div>
    </div>
    <span class="reply-bar-close" onclick="cancelReply()"><i class="fas fa-times"></i></span>
  </div>

  <!-- Footer -->
  <div class="footer">
    <!-- Voice recording state -->
    <div class="voice-rec" id="voice-rec">
      <div class="rec-dot"></div>
      <div class="rec-time" id="rec-time">0:00</div>
      <button class="rec-cancel" onclick="cancelVoice()">Batal</button>
      <button class="rec-send" onclick="sendVoice()">Kirim <i class="fas fa-paper-plane"></i></button>
    </div>
    <!-- Normal input -->
    <div class="footer-main" id="footer-main">
      <button class="icon-btn" onclick="openModal('modal-attach')"><i class="fas fa-paperclip"></i></button>
      <input type="file" id="file-input" style="display:none" onchange="onFileSelect()" multiple>
      <textarea id="msg-input" class="input-box" placeholder="Tulis pesan..."
        rows="1" oninput="onInput(this)" onkeydown="onKey(event)"></textarea>
      <button class="icon-btn" onclick="toggleEmoji()"><i class="fas fa-smile"></i></button>
      <button class="icon-btn" id="voice-btn" onclick="startVoice()"><i class="fas fa-microphone"></i></button>
      <button class="send-btn" id="send-btn" onclick="sendChat()"><i class="fas fa-paper-plane"></i></button>
    </div>

    <!-- Emoji picker -->
    <div class="emoji-picker" id="emoji-picker">
      <div class="emoji-grid" id="emoji-grid"></div>
    </div>
  </div>
</div>

<!-- Context Menu -->
<div class="ctx-menu" id="ctx-menu">
  <div class="ctx-item" onclick="ctxReply()"><i class="fas fa-reply"></i> Balas</div>
  <div class="ctx-item" onclick="ctxCopy()"><i class="fas fa-copy"></i> Salin</div>
  <div class="ctx-item" onclick="ctxPin()"><i class="fas fa-thumbtack"></i> Pin</div>
  <div class="ctx-item" id="ctx-edit" onclick="ctxEdit()"><i class="fas fa-pen"></i> Edit</div>
  <div class="ctx-item danger" id="ctx-delete" onclick="ctxDelete()"><i class="fas fa-trash"></i> Hapus</div>
</div>

<!-- Modal: Room Info / QR -->
<div class="modal" id="modal-info" onclick="if(event.target===this)closeModal('modal-info')">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-title">Info Room <button class="modal-close" onclick="closeModal('modal-info')">&times;</button></div>
    <div style="text-align:center;margin-bottom:16px">
      <div id="qrcode-wrap" style="display:inline-block;background:#fff;padding:12px;border-radius:12px"></div>
    </div>
    <div style="background:var(--surface2);border-radius:10px;padding:12px;font-size:.85rem;display:flex;justify-content:space-between;align-items:center">
      <div><div style="color:var(--text2);font-size:.72rem;margin-bottom:3px">ROOM ID</div><div id="room-id-text" style="font-weight:700;font-family:monospace"></div></div>
      <button class="icon-btn" onclick="copyRoomId()" title="Salin"><i class="fas fa-copy"></i></button>
    </div>
  </div>
</div>

<!-- Modal: Members -->
<div class="modal" id="modal-members" onclick="if(event.target===this)closeModal('modal-members')">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-title">Anggota <span id="member-count" style="color:var(--text2);font-size:.85rem"></span><button class="modal-close" onclick="closeModal('modal-members')">&times;</button></div>
    <div id="member-list"></div>
  </div>
</div>

<!-- Modal: Attach -->
<div class="modal" id="modal-attach" onclick="if(event.target===this)closeModal('modal-attach')">
  <div class="modal-sheet" style="padding-bottom:30px">
    <div class="modal-handle"></div>
    <div class="modal-title">Kirim<button class="modal-close" onclick="closeModal('modal-attach')">&times;</button></div>
    <div class="modal-item" onclick="triggerFile('image/*');closeModal('modal-attach')">
      <i class="fas fa-image"></i><div><div style="font-size:.9rem;font-weight:600">Foto & Video</div><div style="font-size:.75rem;color:var(--text2)">Kirim gambar atau video</div></div>
    </div>
    <div class="modal-item" onclick="triggerFile('*');closeModal('modal-attach')">
      <i class="fas fa-file"></i><div><div style="font-size:.9rem;font-weight:600">Dokumen</div><div style="font-size:.75rem;color:var(--text2)">Semua jenis file, maks. 10 MB</div></div>
    </div>
    <div class="modal-item" onclick="shareLocation();closeModal('modal-attach')">
      <i class="fas fa-map-marker-alt"></i><div><div style="font-size:.9rem;font-weight:600">Lokasi</div><div style="font-size:.75rem;color:var(--text2)">Bagikan lokasi kamu</div></div>
    </div>
  </div>
</div>

<!-- Modal: Settings -->
<div class="modal" id="modal-settings" onclick="if(event.target===this)closeModal('modal-settings')">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-title">Pengaturan<button class="modal-close" onclick="closeModal('modal-settings')">&times;</button></div>
    <div class="toggle-row">
      <div class="toggle-label"><i class="fas fa-volume-up"></i> Suara Notifikasi</div>
      <label class="toggle"><input type="checkbox" id="set-sound" checked onchange="saveSetting()"><span class="toggle-slider"></span></label>
    </div>
    <div class="toggle-row">
      <div class="toggle-label"><i class="fas fa-bell"></i> Notifikasi Desktop</div>
      <label class="toggle"><input type="checkbox" id="set-notif" checked onchange="saveSetting()"><span class="toggle-slider"></span></label>
    </div>
    <div class="toggle-row">
      <div class="toggle-label"><i class="fas fa-download"></i> Kompresi Gambar</div>
      <label class="toggle"><input type="checkbox" id="set-compress" checked onchange="saveSetting()"><span class="toggle-slider"></span></label>
    </div>
  </div>
</div>

<!-- QR Scanner modal -->
<div class="modal" id="modal-scanner" onclick="if(event.target===this)closeScanner()">
  <div class="modal-center">
    <div class="modal-title">Scan QR Code<button class="modal-close" onclick="closeScanner()">&times;</button></div>
    <div id="scanner-area" style="border-radius:12px;overflow:hidden;background:#000;min-height:200px;display:flex;align-items:center;justify-content:center">
      <div style="color:var(--text2);font-size:.85rem">Memuat kamera...</div>
    </div>
    <div style="margin-top:12px;text-align:center;color:var(--text2);font-size:.8rem">Arahkan kamera ke QR Code room</div>
  </div>
</div>

<!-- Reaction picker (dynamic) -->

<!-- Image viewer -->
<div class="img-viewer" id="img-viewer" onclick="closeImgViewer()">
  <img id="img-viewer-img" src="" alt="">
  <button class="img-viewer-close" onclick="closeImgViewer()">&times;</button>
</div>

<!-- Loading -->
<div class="loading" id="loading">
  <div class="spinner"></div>
  <div class="loading-text" id="loading-text">Menghubungkan...</div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let peer = null;
let myId = '';
let myName = '';
let roomId = '';
let roomPass = '';
let encKey = null;
let isHost = false;

// P2P connections
// Host stores: Map<peerId, DataConnection>
// Member stores single: hostConn
let conns = new Map();  // all connections (host uses this for broadcast)
let hostConn = null;    // member's connection to host

let history = [];       // [{id, type, text, sender, senderId, time, timestamp, isMe, ...}]
let members = new Map();// peerId -> {name, avatar}
let pinnedId = null;
let replyMsg = null;
let ctxMsgId = null;

let settings = { sound: true, notif: true, compress: true };
let mediaRec = null, audioChunks = [], recInterval = null, recStart = 0;
let scannerStream = null;

const EMOJIS = 'üòÄüòÉüòÑüòÅüòÜüòÖü§£üòÇüôÇüòâüòäüòáü•∞üòçüòòüòóüòãüòõüòúü§™üòùü§ëü§óü§≠ü§´ü§îü§êüòêüòëüò∂üòèüòíüôÑüò¨üòåüòîüò™üò¥üò∑ü§íü§ïü•µü•∂üòµü§Øüòéü•≥üòïüòüüòÆüò≤üò≥ü•∫üò¶üò®üò∞üò•üò¢üò≠üò±üòñüò£üòûüòìüò©üò´üò§üò°üò†ü§¨üëçüëé‚ù§Ô∏èüî•‚úÖüôèüíØüëÄ'.split('');

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SETUP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.onload = () => {
  loadSettings();
  buildEmoji();
  const saved = localStorage.getItem('dc_name');
  if (saved) { document.getElementById('inp-name').value = saved; updateSetupAvatar(); }
  document.getElementById('setup-avatar').src = avatarUrl('?');
};

function updateSetupAvatar() {
  const n = document.getElementById('inp-name').value || '?';
  document.getElementById('setup-avatar').src = avatarUrl(n);
}

function startApp(host) {
  myName = document.getElementById('inp-name').value.trim();
  roomId = document.getElementById('inp-room').value.trim();
  roomPass = document.getElementById('inp-pass').value.trim();

  if (!myName) { showToast('Masukkan username dulu'); return; }
  if (!roomId) { showToast('Masukkan Room ID dulu'); return; }

  localStorage.setItem('dc_name', myName);
  isHost = host;
  encKey = roomPass ? CryptoJS.SHA256(roomPass + roomId).toString() : null;

  initPeer();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PEER INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function initPeer() {
  showLoading(isHost ? 'Membuat room...' : 'Menghubungkan ke room...');

  // Destroy existing peer cleanly
  if (peer) { try { peer.destroy(); } catch(e){} }
  peer = null; conns.clear(); hostConn = null;

  const peerId = isHost ? roomId : roomId + '_' + Date.now();

  peer = new Peer(peerId, {
    config: {
      iceServers: [
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'stun:stun1.l.google.com:19302' },
        { urls: 'turn:global.relay.metered.ca:80', username: '0d1e3d79680848ed401e2c37', credential: 'lqk7+TguBu83AWQW' },
        { urls: 'turn:global.relay.metered.ca:80?transport=tcp', username: '0d1e3d79680848ed401e2c37', credential: 'lqk7+TguBu83AWQW' },
        { urls: 'turn:global.relay.metered.ca:443', username: '0d1e3d79680848ed401e2c37', credential: 'lqk7+TguBu83AWQW' },
      ]
    }
  });

  peer.on('open', (id) => {
    myId = id;
    hideLoading();
    showChatScreen();

    if (isHost) {
      setStatus('Menunggu anggota...', false);
      sysMsg('Room dibuat. ID: ' + roomId);
      loadHistory();
    } else {
      connectToHost();
    }
  });

  // HOST: accept incoming connections
  peer.on('connection', (conn) => {
    if (!isHost) return;
    setupConn(conn);
  });

  peer.on('error', (err) => {
    hideLoading();
    console.error('Peer error:', err.type, err);
    if (err.type === 'peer-unavailable') {
      showToast('‚ùå Room tidak ditemukan. Pastikan host sudah membuat room.');
    } else if (err.type === 'unavailable-id') {
      showToast('‚ùå Room ID sudah dipakai. Coba ID lain.');
    } else {
      showToast('‚ùå Error: ' + (err.message || err.type));
    }
    document.getElementById('reconnect-btn').style.display = 'inline-block';
  });

  peer.on('disconnected', () => {
    setStatus('Terputus', false);
    document.getElementById('reconnect-btn').style.display = 'inline-block';
  });
}

function connectToHost() {
  setStatus('Menghubungkan...', false);
  const conn = peer.connect(roomId, { reliable: true, serialization: 'json' });
  hostConn = conn;
  setupConn(conn);
}

function setupConn(conn) {
  // Store immediately
  conns.set(conn.peer, conn);

  conn.on('open', () => {
    // Re-store on open (in case of replacement)
    conns.set(conn.peer, conn);

    // Hide reconnect button
    document.getElementById('reconnect-btn').style.display = 'none';

    if (!isHost) {
      hostConn = conn;
      setStatus('Terhubung', true);
      // Introduce ourselves
      send(conn, { t: 'join', name: myName, avatar: avatarUrl(myName) });
    }
    // Host side: wait for join message
  });

  conn.on('data', (data) => {
    handleData(data, conn);
  });

  conn.on('close', () => {
    conns.delete(conn.peer);
    members.delete(conn.peer);
    renderMembers();

    if (!isHost) {
      hostConn = null;
      setStatus('Terputus dari host', false);
      document.getElementById('reconnect-btn').style.display = 'inline-block';
    } else {
      const m = members.get(conn.peer);
      if (m) sysMsg(m.name + ' keluar');
    }
  });

  conn.on('error', (e) => {
    console.error('conn error', e);
    if (!isHost) {
      setStatus('Error koneksi', false);
      document.getElementById('reconnect-btn').style.display = 'inline-block';
    }
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DATA HANDLER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function handleData(data, conn) {
  switch (data.t) {

    case 'join':
      members.set(conn.peer, { name: data.name, avatar: data.avatar });
      renderMembers();
      if (isHost) {
        setStatus(members.size + ' anggota', true);
        // Send full history to new member
        send(conn, { t: 'history', history: history, members: membersArr() });
        // Notify others
        broadcast({ t: 'member_update', members: membersArr() }, conn.peer);
        sysMsg(data.name + ' bergabung');
        // Relay join-announce to all
        broadcast({ t: 'announce', text: data.name + ' bergabung' }, conn.peer);
      }
      break;

    case 'announce':
      sysMsg(data.text);
      break;

    case 'history':
      history = data.history || [];
      if (data.members) {
        data.members.forEach(([id, m]) => members.set(id, m));
      }
      saveHistory();
      renderAll();
      renderMembers();
      setStatus(members.size + ' anggota', true);
      break;

    case 'member_update':
      if (data.members) {
        data.members.forEach(([id, m]) => members.set(id, m));
      }
      renderMembers();
      break;

    case 'msg':
      receiveMsg(data);
      if (isHost) broadcast(data, conn.peer);
      break;

    case 'delete':
      doDelete(data.id);
      if (isHost) broadcast(data, conn.peer);
      break;

    case 'edit':
      doEdit(data.id, data.text, data.orig);
      if (isHost) broadcast(data, conn.peer);
      break;

    case 'react':
      doReact(data.id, data.emoji, data.sender);
      if (isHost) broadcast(data, conn.peer);
      break;

    case 'pin':
      pinnedId = data.id;
      savePinned();
      renderPinned();
      if (isHost) broadcast(data, conn.peer);
      break;

    case 'unpin':
      pinnedId = null;
      savePinned();
      renderPinned();
      if (isHost) broadcast(data, conn.peer);
      break;

    case 'read':
      doRead(data.ids);
      if (isHost) broadcast(data, conn.peer);
      break;
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SEND HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function send(conn, data) {
  try { if (conn && conn.open) conn.send(data); }
  catch(e) { console.error('send error', e); }
}

function broadcast(data, excludeId = null) {
  conns.forEach((c, id) => {
    if (id !== excludeId) send(c, data);
  });
}

function emit(data) {
  // Emit from this client to the network
  if (isHost) {
    broadcast(data);
  } else {
    send(hostConn, data);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MESSAGES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function sendChat() {
  const el = document.getElementById('msg-input');
  const txt = el.value.trim();
  if (!txt) return;

  const msgText = encKey ? encrypt(txt) : txt;

  const msg = {
    id: Date.now() + '_' + myId,
    type: 'text',
    text: msgText,
    orig: txt,
    sender: myName,
    senderId: myId,
    time: fmtTime(new Date()),
    timestamp: Date.now(),
    replyTo: replyMsg ? { id: replyMsg.id, sender: replyMsg.sender, text: replyMsg.orig || replyMsg.text, type: replyMsg.type } : null,
    reactions: {},
    status: 'sent'
  };

  addMsg(msg, true);
  emit({ t: 'msg', ...msg });

  el.value = ''; el.style.height = ''; cancelReply();
  toggleSendBtn();
  playSound();
}

function receiveMsg(data) {
  if (data.type === 'text' && encKey && !data.orig) {
    data.orig = decrypt(data.text);
  }
  addMsg(data, false);
  playSound();
  notifyDesktop(data);
  // Mark as read after 1s
  setTimeout(() => {
    emit({ t: 'read', ids: [data.id] });
  }, 1000);
}

function addMsg(msg, isMe) {
  const m = { ...msg, isMe };
  history.push(m);
  saveHistory();
  renderMsg(m);
  scrollToBottom();
}

function sysMsg(text) {
  const m = { id: Date.now() + '_sys', type: 'sys', text, isMe: false, timestamp: Date.now() };
  history.push(m);
  renderMsg(m);
  scrollToBottom();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RENDER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderAll() {
  const area = document.getElementById('chat-area');
  area.innerHTML = '';
  let lastDay = null;
  history.forEach(m => {
    if (m.type !== 'sys' && m.timestamp) {
      const day = dayLabel(m.timestamp);
      if (day !== lastDay) { lastDay = day; insertDateSep(area, day); }
    }
    renderMsg(m, false);
  });
  scrollToBottom();
}

function renderMsg(m, withDateSep = true) {
  const area = document.getElementById('chat-area');

  // Date separator for live messages
  if (withDateSep && m.type !== 'sys' && m.timestamp) {
    const day = dayLabel(m.timestamp);
    const seps = area.querySelectorAll('.date-sep span');
    const lastSep = seps.length ? seps[seps.length-1].textContent : null;
    if (day !== lastSep) insertDateSep(area, day);
  }

  const row = document.createElement('div');
  row.className = 'msg-row ' + (m.type === 'sys' ? 'sys' : m.isMe ? 'me' : 'them');
  row.dataset.id = m.id;

  if (m.type === 'sys') {
    row.innerHTML = `<div class="bubble">${escHtml(m.text)}</div>`;
  } else {
    const isMe = m.isMe;
    row.innerHTML = buildBubble(m, isMe);
  }

  area.appendChild(row);
}

function buildBubble(m, isMe) {
  const dtext = m.orig || m.text || '';
  let body = '';

  switch (m.type) {
    case 'text':
      body = `<span>${escHtml(dtext)}</span>`;
      break;
    case 'image':
      body = `<img src="${m.content}" class="chat-img" onclick="openImg('${m.content}')" loading="lazy">`;
      break;
    case 'video':
      body = `<video src="${m.content}" class="chat-img" controls></video>`;
      break;
    case 'file':
      body = `<a href="${m.content}" download="${escHtml(m.fname)}" class="chat-file">
        <i class="${fileIcon(m.ftype)}"></i>
        <div><div>${escHtml(m.fname)}</div><div style="font-size:.72rem;opacity:.7">${fmtSize(m.fsize)}</div></div>
      </a>`;
      break;
    case 'voice':
      body = `<div class="chat-voice">
        <button class="voice-play" onclick="playVoice('${m.id}',this)"><i class="fas fa-play"></i></button>
        <div class="voice-waveform">${genWave()}</div>
        <span class="voice-dur">${m.dur||'0:00'}</span>
      </div>
      <audio id="aud_${m.id}" src="${m.content}" style="display:none"></audio>`;
      break;
    case 'location':
      body = `<a href="https://maps.google.com/?q=${m.lat},${m.lng}" target="_blank" class="chat-location">
        <i class="fas fa-map-marker-alt" style="color:var(--accent)"></i>
        <div><div style="font-weight:600">Lokasi</div><div style="font-size:.72rem;opacity:.7">${m.lat.toFixed(5)}, ${m.lng.toFixed(5)}</div></div>
      </a>`;
      break;
  }

  const replyHtml = m.replyTo ? `
    <div class="reply-preview" onclick="scrollToMsg('${m.replyTo.id}')">
      <div class="reply-preview-name">${escHtml(m.replyTo.sender)}</div>
      <div class="reply-preview-text">${m.replyTo.type === 'image' ? 'üì∑ Foto' : m.replyTo.type === 'voice' ? 'üé§ Pesan suara' : m.replyTo.type === 'file' ? 'üìé File' : escHtml(m.replyTo.text || '')}</div>
    </div>` : '';

  const reactions = buildReactions(m);
  const edited = m.edited ? '<span class="edited-label">diedit</span>' : '';
  let statusIco = '';
  if (isMe) {
    if (m.status === 'read') statusIco = '<i class="fas fa-check-double msg-status read"></i>';
    else if (m.status === 'delivered') statusIco = '<i class="fas fa-check-double msg-status"></i>';
    else statusIco = '<i class="fas fa-check msg-status"></i>';
  }

  return `<div class="bubble" oncontextmenu="openCtx(event,'${m.id}');return false" ontouchstart="touchStart(event,'${m.id}')" ontouchend="touchEnd()">
    ${!isMe ? `<div class="bubble-sender">${escHtml(m.sender)}</div>` : ''}
    ${replyHtml}${body}${reactions}
    <div class="bubble-meta">
      <span class="bubble-time">${m.time}</span>
      ${edited}${statusIco}
      <div class="bubble-actions">
        <span class="ba-btn" onclick="setReply('${m.id}')"><i class="fas fa-reply"></i></span>
        <span class="ba-btn" onclick="openReactPicker(event,'${m.id}')"><i class="fas fa-smile"></i></span>
        <span class="ba-btn" onclick="openCtx(event,'${m.id}')"><i class="fas fa-ellipsis-v"></i></span>
      </div>
    </div>
  </div>`;
}

function buildReactions(m) {
  if (!m.reactions || !Object.keys(m.reactions).length) return '';
  const counts = {};
  Object.values(m.reactions).forEach(e => counts[e] = (counts[e]||0)+1);
  return '<div class="reactions">' +
    Object.entries(counts).map(([e,c]) =>
      `<span class="reaction" onclick="doReact_me('${m.id}','${e}')">${e}<span style="font-size:.7rem;margin-left:2px">${c}</span></span>`
    ).join('') + '</div>';
}

function insertDateSep(area, label) {
  const d = document.createElement('div');
  d.className = 'date-sep';
  d.innerHTML = `<span>${label}</span>`;
  area.appendChild(d);
}

function refreshMsg(id) {
  const m = history.find(x => x.id === id); if (!m) return;
  const row = document.querySelector(`.msg-row[data-id="${id}"]`); if (!row) return;
  row.querySelector('.bubble').outerHTML = buildBubble(m, m.isMe);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MESSAGE ACTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function doDelete(id) {
  const m = history.find(x => x.id === id); if (!m) return;
  m.deleted = true; m.text = 'Pesan ini dihapus'; m.orig = 'Pesan ini dihapus';
  saveHistory();
  const row = document.querySelector(`.msg-row[data-id="${id}"]`);
  if (row) {
    const b = row.querySelector('.bubble');
    b.innerHTML = `<span style="font-style:italic;opacity:.6">Pesan ini dihapus</span>
      <div class="bubble-meta"><span class="bubble-time">${m.time}</span></div>`;
  }
}

function doEdit(id, text, orig) {
  const m = history.find(x => x.id === id); if (!m) return;
  m.text = text; m.orig = orig || (encKey ? null : text); m.edited = true;
  saveHistory();
  const row = document.querySelector(`.msg-row[data-id="${id}"]`); if (!row) return;
  const b = row.querySelector('.bubble'); if (!b) return;
  b.outerHTML = buildBubble(m, m.isMe);
}

function doReact(id, emoji, sender) {
  const m = history.find(x => x.id === id); if (!m) return;
  if (!m.reactions) m.reactions = {};
  if (m.reactions[sender] === emoji) delete m.reactions[sender];
  else m.reactions[sender] = emoji;
  saveHistory();
  const row = document.querySelector(`.msg-row[data-id="${id}"]`); if (!row) return;
  const existing = row.querySelector('.reactions');
  const newHtml = buildReactions(m);
  if (existing) existing.outerHTML = newHtml || '';
  else {
    const meta = row.querySelector('.bubble-meta');
    if (meta) meta.insertAdjacentHTML('beforebegin', newHtml);
  }
}

function doRead(ids) {
  ids.forEach(id => {
    const m = history.find(x => x.id === id); if (!m) return;
    m.status = 'read';
    const row = document.querySelector(`.msg-row[data-id="${id}"]`);
    if (row) {
      const s = row.querySelector('.msg-status');
      if (s) { s.className = 'fas fa-check-double msg-status read'; }
    }
  });
  saveHistory();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CONTEXT MENU
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let touchTimer = null;
function touchStart(e, id) {
  touchTimer = setTimeout(() => openCtx(e, id), 600);
}
function touchEnd() { clearTimeout(touchTimer); }

function openCtx(e, id) {
  e.preventDefault();
  ctxMsgId = id;
  const m = history.find(x => x.id === id);
  const isMe = m && m.isMe;
  document.getElementById('ctx-edit').style.display = (isMe && m.type === 'text' && !m.deleted) ? 'flex' : 'none';
  document.getElementById('ctx-delete').style.display = isMe ? 'flex' : 'none';

  const menu = document.getElementById('ctx-menu');
  menu.style.display = 'block';
  const x = Math.min(e.clientX || e.touches?.[0]?.clientX || 0, window.innerWidth - 170);
  const y = Math.min(e.clientY || e.touches?.[0]?.clientY || 0, window.innerHeight - 200);
  menu.style.left = x + 'px';
  menu.style.top = y + 'px';
  setTimeout(() => document.addEventListener('click', closeCtx, { once: true }), 50);
}
function closeCtx() { document.getElementById('ctx-menu').style.display = 'none'; }

function ctxReply() { setReply(ctxMsgId); closeCtx(); }
function ctxCopy() {
  const m = history.find(x => x.id === ctxMsgId);
  if (m && m.type === 'text') { navigator.clipboard?.writeText(m.orig || m.text).catch(()=>{}); showToast('Disalin'); }
  closeCtx();
}
function ctxPin() {
  pinnedId = ctxMsgId; savePinned(); renderPinned();
  emit({ t: 'pin', id: pinnedId });
  closeCtx();
}
function ctxEdit() {
  const m = history.find(x => x.id === ctxMsgId);
  if (!m) return;
  const newText = prompt('Edit pesan:', m.orig || m.text);
  if (!newText || newText === (m.orig || m.text)) return;
  const encoded = encKey ? encrypt(newText) : newText;
  doEdit(ctxMsgId, encoded, newText);
  emit({ t: 'edit', id: ctxMsgId, text: encoded, orig: encKey ? null : newText });
  closeCtx();
}
function ctxDelete() {
  if (!confirm('Hapus pesan ini?')) return;
  doDelete(ctxMsgId);
  emit({ t: 'delete', id: ctxMsgId });
  closeCtx();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  REACTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function doReact_me(id, emoji) {
  doReact(id, emoji, myId);
  emit({ t: 'react', id, emoji, sender: myId });
}

function openReactPicker(e, id) {
  e.stopPropagation();
  document.querySelectorAll('.react-picker').forEach(x => x.remove());
  const emos = ['‚ù§Ô∏è','üëç','üòÇ','üòÆ','üò¢','üôè'];
  const div = document.createElement('div');
  div.className = 'react-picker emoji-picker';
  div.style.cssText = `display:flex;position:fixed;flex-direction:row;gap:6px;padding:10px;bottom:auto;
    left:${Math.min(e.clientX-100,window.innerWidth-230)}px;top:${Math.max(e.clientY-60,10)}px;z-index:500;`;
  emos.forEach(em => {
    const s = document.createElement('span');
    s.className = 'emoji-item';
    s.textContent = em;
    s.onclick = () => { doReact_me(id, em); div.remove(); };
    div.appendChild(s);
  });
  document.body.appendChild(div);
  setTimeout(() => document.addEventListener('click', () => div.remove(), { once: true }), 50);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  REPLY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setReply(id) {
  const m = history.find(x => x.id === id); if (!m) return;
  replyMsg = m;
  document.getElementById('reply-bar').style.display = 'flex';
  document.getElementById('reply-bar-name').textContent = 'Balas ' + m.sender;
  document.getElementById('reply-bar-text').textContent =
    m.type === 'image' ? 'üì∑ Foto' : m.type === 'voice' ? 'üé§ Pesan suara' :
    m.type === 'file' ? 'üìé ' + m.fname : (m.orig || m.text || '');
  document.getElementById('msg-input').focus();
}
function cancelReply() {
  replyMsg = null;
  document.getElementById('reply-bar').style.display = 'none';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FILE / MEDIA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function triggerFile(accept) {
  const el = document.getElementById('file-input');
  el.accept = accept; el.click();
}
function onFileSelect() {
  const files = document.getElementById('file-input').files;
  if (!files.length) return;
  Array.from(files).forEach(f => {
    if (f.size > 10 * 1024 * 1024) { showToast(f.name + ' terlalu besar (maks 10 MB)'); return; }
    processFile(f);
  });
  document.getElementById('file-input').value = '';
}
function processFile(f) {
  showLoading('Memproses ' + f.name + '...');
  const reader = new FileReader();
  reader.onload = e => {
    const content = e.target.result;
    const isImg = f.type.startsWith('image/');
    const isVid = f.type.startsWith('video/');
    if (isImg && settings.compress) {
      compressImg(content, compressed => { sendFilemsg(f, compressed); hideLoading(); });
    } else {
      sendFilemsg(f, content); hideLoading();
    }
  };
  reader.readAsDataURL(f);
}
function sendFilemsg(f, content) {
  const isImg = f.type.startsWith('image/');
  const isVid = f.type.startsWith('video/');
  const msg = {
    id: Date.now() + '_' + myId,
    type: isImg ? 'image' : isVid ? 'video' : 'file',
    content, fname: f.name, fsize: f.size, ftype: f.type,
    sender: myName, senderId: myId,
    time: fmtTime(new Date()), timestamp: Date.now(),
    replyTo: replyMsg ? { id: replyMsg.id, sender: replyMsg.sender, text: replyMsg.orig||replyMsg.text, type: replyMsg.type } : null,
    reactions: {}, status: 'sent'
  };
  addMsg(msg, true);
  emit({ t: 'msg', ...msg });
  cancelReply(); playSound();
}
function compressImg(src, cb) {
  const img = new Image();
  img.onload = () => {
    const canvas = document.createElement('canvas');
    let w = img.width, h = img.height, max = 1600;
    if (w > max || h > max) { if (w > h) { h = h/w*max; w = max; } else { w = w/h*max; h = max; } }
    canvas.width = w; canvas.height = h;
    canvas.getContext('2d').drawImage(img, 0, 0, w, h);
    cb(canvas.toDataURL('image/jpeg', 0.82));
  };
  img.src = src;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  LOCATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function shareLocation() {
  if (!navigator.geolocation) { showToast('Lokasi tidak didukung browser ini'); return; }
  showLoading('Mendapatkan lokasi...');
  navigator.geolocation.getCurrentPosition(pos => {
    hideLoading();
    const msg = {
      id: Date.now() + '_' + myId,
      type: 'location', lat: pos.coords.latitude, lng: pos.coords.longitude,
      sender: myName, senderId: myId,
      time: fmtTime(new Date()), timestamp: Date.now(),
      reactions: {}, status: 'sent'
    };
    addMsg(msg, true);
    emit({ t: 'msg', ...msg });
    playSound();
  }, err => { hideLoading(); showToast('Gagal mendapatkan lokasi'); });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  VOICE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function startVoice() {
  if (!navigator.mediaDevices) { showToast('Perekaman suara tidak didukung'); return; }
  navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
    audioChunks = [];
    mediaRec = new MediaRecorder(stream);
    mediaRec.ondataavailable = e => audioChunks.push(e.data);
    mediaRec.start();
    recStart = Date.now();
    document.getElementById('footer-main').style.display = 'none';
    document.getElementById('voice-rec').classList.add('active');
    recInterval = setInterval(() => {
      const s = Math.floor((Date.now()-recStart)/1000);
      document.getElementById('rec-time').textContent = Math.floor(s/60)+':'+(s%60+'').padStart(2,'0');
    }, 500);
  }).catch(() => showToast('Tidak bisa akses mikrofon'));
}
function cancelVoice() {
  if (mediaRec) { mediaRec.stop(); mediaRec.stream.getTracks().forEach(t=>t.stop()); mediaRec = null; }
  clearInterval(recInterval);
  document.getElementById('voice-rec').classList.remove('active');
  document.getElementById('footer-main').style.display = 'flex';
}
function sendVoice() {
  if (!mediaRec) return;
  mediaRec.stop();
  mediaRec.onstop = () => {
    const blob = new Blob(audioChunks, { type: 'audio/webm' });
    const reader = new FileReader();
    reader.onload = e => {
      const dur = Date.now()-recStart;
      const s = Math.floor(dur/1000);
      const msg = {
        id: Date.now()+'_'+myId, type: 'voice',
        content: e.target.result,
        dur: Math.floor(s/60)+':'+(s%60+'').padStart(2,'0'),
        sender: myName, senderId: myId,
        time: fmtTime(new Date()), timestamp: Date.now(),
        replyTo: replyMsg ? { id: replyMsg.id, sender: replyMsg.sender, text: replyMsg.orig||replyMsg.text, type: replyMsg.type } : null,
        reactions: {}, status: 'sent'
      };
      addMsg(msg, true);
      emit({ t: 'msg', ...msg });
      cancelReply(); playSound();
    };
    reader.readAsDataURL(blob);
    mediaRec.stream.getTracks().forEach(t=>t.stop()); mediaRec = null;
  };
  clearInterval(recInterval);
  document.getElementById('voice-rec').classList.remove('active');
  document.getElementById('footer-main').style.display = 'flex';
}
function playVoice(id, btn) {
  const aud = document.getElementById('aud_'+id);
  const ico = btn.querySelector('i');
  if (aud.paused) {
    document.querySelectorAll('audio').forEach(a => { a.pause(); a.currentTime = 0; });
    document.querySelectorAll('.voice-play i').forEach(i => i.className='fas fa-play');
    aud.play(); ico.className = 'fas fa-pause';
    aud.onended = () => ico.className = 'fas fa-play';
  } else { aud.pause(); aud.currentTime = 0; ico.className = 'fas fa-play'; }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PINNED
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderPinned() {
  const bar = document.getElementById('pinned-bar');
  if (!pinnedId) { bar.style.display = 'none'; return; }
  const m = history.find(x => x.id === pinnedId);
  if (!m) { bar.style.display = 'none'; return; }
  const txt = m.type==='text' ? (m.orig||m.text) : m.type==='image' ? 'üì∑ Foto' : m.type==='voice' ? 'üé§ Suara' : 'üìé File';
  document.getElementById('pinned-bar-text').textContent = m.sender + ': ' + txt;
  bar.style.display = 'flex';
}
function scrollToPinned() {
  if (!pinnedId) return;
  scrollToMsg(pinnedId);
}
function unpinAll() {
  pinnedId = null; savePinned(); renderPinned();
  emit({ t: 'unpin' });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MEMBERS PANEL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderMembers() {
  const list = document.getElementById('member-list');
  const allMembers = [
    [myId, { name: myName + ' (kamu)', avatar: avatarUrl(myName) }],
    ...members.entries()
  ];
  list.innerHTML = allMembers.map(([id, m]) => `
    <div class="member-item">
      <img class="member-avatar" src="${m.avatar||avatarUrl(m.name)}" alt="">
      <div><div class="member-name">${escHtml(m.name)}</div><div class="member-tag">${id===myId?'Kamu':''}</div></div>
    </div>`).join('');
  document.getElementById('member-count').textContent = '(' + allMembers.length + ')';
  const count = allMembers.length;
  if (count > 1) setStatus(count + ' anggota', true);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  EMOJI
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildEmoji() {
  const grid = document.getElementById('emoji-grid');
  EMOJIS.forEach(e => {
    const s = document.createElement('span');
    s.className = 'emoji-item'; s.textContent = e;
    s.onclick = () => { insertEmoji(e); };
    grid.appendChild(s);
  });
}
function insertEmoji(e) {
  const el = document.getElementById('msg-input');
  const start = el.selectionStart, end = el.selectionEnd;
  el.value = el.value.slice(0,start) + e + el.value.slice(end);
  el.selectionStart = el.selectionEnd = start + e.length;
  el.focus(); toggleSendBtn();
}
function toggleEmoji() {
  const p = document.getElementById('emoji-picker');
  p.style.display = p.style.display === 'block' ? 'none' : 'block';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INPUT HANDLERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function onInput(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 120) + 'px';
  toggleSendBtn();
}
function onKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendChat(); }
}
function toggleSendBtn() {
  const has = document.getElementById('msg-input').value.trim().length > 0;
  document.getElementById('send-btn').classList.toggle('show', has);
  document.getElementById('voice-btn').style.display = has ? 'none' : 'flex';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SCROLL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function scrollToBottom() {
  const a = document.getElementById('chat-area');
  a.scrollTop = a.scrollHeight;
  document.getElementById('scroll-btn').style.display = 'none';
}
function onScroll() {
  const a = document.getElementById('chat-area');
  const atBottom = a.scrollHeight - a.scrollTop - a.clientHeight < 80;
  document.getElementById('scroll-btn').style.display = atBottom ? 'none' : 'flex';
}
function scrollToMsg(id) {
  const el = document.querySelector(`.msg-row[data-id="${id}"]`); if (!el) return;
  el.scrollIntoView({ behavior: 'smooth', block: 'center' });
  const b = el.querySelector('.bubble');
  b.style.outline = '2px solid var(--accent3)';
  setTimeout(() => b.style.outline = '', 1800);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  QR & ROOM INFO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showRoomInfo() {
  const wrap = document.getElementById('qrcode-wrap');
  wrap.innerHTML = '';
  const qrData = JSON.stringify({ id: roomId, p: roomPass || '' });
  new QRCode(wrap, { text: qrData, width: 180, height: 180, correctLevel: QRCode.CorrectLevel.H });
  document.getElementById('room-id-text').textContent = roomId;
  openModal('modal-info');
}
function copyRoomId() {
  navigator.clipboard?.writeText(roomId).catch(()=>{});
  showToast('Room ID disalin: ' + roomId);
}

// QR Scanner (basic: use prompt as fallback since html5-qrcode CDN removed)
function openScanner() {
  const id = prompt('Masukkan Room ID secara manual (atau tempel data QR JSON):');
  if (!id) return;
  try {
    const parsed = JSON.parse(id);
    if (parsed.id) {
      document.getElementById('inp-room').value = parsed.id;
      if (parsed.p) document.getElementById('inp-pass').value = parsed.p;
      showToast('Room ID diisi: ' + parsed.id);
    }
  } catch(e) {
    document.getElementById('inp-room').value = id.trim();
    showToast('Room ID diisi');
  }
}
function closeScanner() { closeModal('modal-scanner'); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RECONNECT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function manualReconnect() {
  document.getElementById('reconnect-btn').style.display = 'none';
  if (!isHost) {
    // Try to reconnect without full reinit
    if (peer && !peer.destroyed) {
      try {
        connectToHost();
        return;
      } catch(e) {}
    }
    initPeer();
  } else {
    initPeer();
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  UI HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showChatScreen() {
  document.getElementById('screen-setup').style.display = 'none';
  document.getElementById('screen-chat').style.display = 'flex';
  document.getElementById('screen-chat').style.flexDirection = 'column';

  const title = 'Room ' + roomId;
  document.getElementById('hdr-title').textContent = title;
  document.getElementById('hdr-avatar').src = avatarUrl(roomId);

  members.set(myId, { name: myName, avatar: avatarUrl(myName) });
  renderMembers();
  loadHistory();
  loadPinned();
}

function setStatus(text, online) {
  document.getElementById('status-text').textContent = text;
  document.getElementById('status-dot').className = 'status-dot' + (online ? ' on' : '');
}

function showLoading(txt = 'Loading...') {
  document.getElementById('loading-text').textContent = txt;
  document.getElementById('loading').classList.add('show');
}
function hideLoading() {
  document.getElementById('loading').classList.remove('show');
}

let toastTimer;
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.style.display = 'block';
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.style.display = 'none', 3000);
}

function openModal(id) { document.getElementById(id).classList.add('show'); if (id === 'modal-info') showRoomInfo(); }
function closeModal(id) { document.getElementById(id).classList.remove('show'); }

function openImg(src) {
  document.getElementById('img-viewer-img').src = src;
  document.getElementById('img-viewer').classList.add('show');
}
function closeImgViewer() { document.getElementById('img-viewer').classList.remove('show'); }

function toggleTheme() {
  const cur = document.body.getAttribute('data-theme');
  const next = cur === 'light' ? null : 'light';
  if (next) document.body.setAttribute('data-theme', 'light');
  else document.body.removeAttribute('data-theme');
  document.getElementById('theme-icon').className = next === 'light' ? 'fas fa-moon' : 'fas fa-sun';
  localStorage.setItem('dc_theme', next || 'dark');
}

// Close emoji picker on outside click
document.addEventListener('click', e => {
  if (!e.target.closest('.emoji-picker') && !e.target.closest('.fa-smile')) {
    document.getElementById('emoji-picker').style.display = 'none';
  }
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  NOTIFICATIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const sndCtx = window.AudioContext || window.webkitAudioContext;
let audioCtx;
function playSound() {
  if (!settings.sound) return;
  try {
    if (!audioCtx) audioCtx = new sndCtx();
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.connect(g); g.connect(audioCtx.destination);
    o.type = 'sine'; o.frequency.setValueAtTime(880, audioCtx.currentTime);
    g.gain.setValueAtTime(0.15, audioCtx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.15);
    o.start(); o.stop(audioCtx.currentTime + 0.15);
  } catch(e) {}
}

function notifyDesktop(msg) {
  if (!settings.notif || document.hasFocus()) return;
  if (Notification.permission !== 'granted') { Notification.requestPermission(); return; }
  const body = msg.type === 'text' ? (msg.orig||msg.text) : msg.type === 'image' ? 'üì∑ Foto' : 'üìé File';
  new Notification(msg.sender, { body, icon: avatarUrl(msg.sender), tag: 'dechat' });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ENCRYPTION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function encrypt(text) { return CryptoJS.AES.encrypt(text, encKey).toString(); }
function decrypt(cipher) {
  try { return CryptoJS.AES.decrypt(cipher, encKey).toString(CryptoJS.enc.Utf8) || '[Terenkripsi]'; }
  catch(e) { return '[Terenkripsi]'; }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PERSISTENCE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function saveHistory() {
  try { localStorage.setItem('dc_h_' + roomId, JSON.stringify(history)); } catch(e) {}
}
function loadHistory() {
  try {
    const s = localStorage.getItem('dc_h_' + roomId);
    if (s) { history = JSON.parse(s); renderAll(); }
  } catch(e) { history = []; }
}
function savePinned() {
  try { localStorage.setItem('dc_p_' + roomId, pinnedId || ''); } catch(e) {}
}
function loadPinned() {
  pinnedId = localStorage.getItem('dc_p_' + roomId) || null;
  renderPinned();
}
function loadSettings() {
  try {
    const s = localStorage.getItem('dc_settings');
    if (s) settings = { ...settings, ...JSON.parse(s) };
    document.getElementById('set-sound').checked = settings.sound;
    document.getElementById('set-notif').checked = settings.notif;
    document.getElementById('set-compress').checked = settings.compress;
    const theme = localStorage.getItem('dc_theme');
    if (theme === 'light') { document.body.setAttribute('data-theme','light'); document.getElementById('theme-icon').className='fas fa-moon'; }
  } catch(e) {}
}
function saveSetting() {
  settings.sound = document.getElementById('set-sound').checked;
  settings.notif = document.getElementById('set-notif').checked;
  settings.compress = document.getElementById('set-compress').checked;
  try { localStorage.setItem('dc_settings', JSON.stringify(settings)); } catch(e) {}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  UTILS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function avatarUrl(name) {
  return `https://ui-avatars.com/api/?name=${encodeURIComponent(name||'?')}&background=2563eb&color=fff&size=128&bold=true`;
}
function escHtml(s) {
  if (!s) return '';
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
function fmtTime(d) { return d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}); }
function fmtSize(b) {
  if (!b) return '';
  if (b < 1024) return b + ' B';
  if (b < 1048576) return (b/1024).toFixed(1) + ' KB';
  return (b/1048576).toFixed(1) + ' MB';
}
function fileIcon(t) {
  if (!t) return 'fas fa-file';
  if (t.includes('pdf')) return 'fas fa-file-pdf';
  if (t.includes('word')||t.includes('document')) return 'fas fa-file-word';
  if (t.includes('sheet')||t.includes('excel')) return 'fas fa-file-excel';
  if (t.includes('zip')||t.includes('rar')) return 'fas fa-file-archive';
  if (t.includes('video')) return 'fas fa-file-video';
  if (t.includes('audio')) return 'fas fa-file-audio';
  return 'fas fa-file';
}
function genWave() {
  let h=''; for(let i=0;i<28;i++) h+=`<div class="voice-bar" style="height:${Math.random()*18+4}px"></div>`;
  return h;
}
function dayLabel(ts) {
  const d = new Date(ts), now = new Date();
  const sameDay = (a,b) => a.getDate()===b.getDate()&&a.getMonth()===b.getMonth()&&a.getFullYear()===b.getFullYear();
  if (sameDay(d,now)) return 'Hari Ini';
  const yest = new Date(); yest.setDate(now.getDate()-1);
  if (sameDay(d,yest)) return 'Kemarin';
  const days=['Minggu','Senin','Selasa','Rabu','Kamis','Jumat','Sabtu'];
  const mons=['Jan','Feb','Mar','Apr','Mei','Jun','Jul','Agu','Sep','Okt','Nov','Des'];
  const diff = Math.floor((now-d)/86400000);
  if (diff < 7) return days[d.getDay()];
  return d.getDate()+' '+mons[d.getMonth()]+' '+d.getFullYear();
}
function membersArr() { return Array.from(members.entries()); }
</script>
</body>
</html>
