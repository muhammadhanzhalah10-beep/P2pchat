<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
    <title>Chat P2P - Clean Edition</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --bg-color: #0b141a;
            --header-bg: #202c33;
            --input-bg: #2a3942;
            --text-primary: #e9edef;
            --text-secondary: #8696a0;
            --accent: #00a884;
            --bubble-me: #005c4b;
            --bubble-them: #202c33;
            --danger: #ef5350;
        }

        [data-theme="light"] {
            --bg-color: #efeae2;
            --header-bg: #f0f2f5;
            --input-bg: #ffffff;
            --text-primary: #111b21;
            --text-secondary: #667781;
            --accent: #00a884;
            --bubble-me: #d9fdd3;
            --bubble-them: #ffffff;
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0; background: var(--bg-color); color: var(--text-primary); 
            height: 100dvh; width: 100%; display: flex; flex-direction: column; overflow: hidden; 
        }

        .header { 
            background: var(--header-bg); padding: 10px 15px; display: flex; 
            align-items: center; justify-content: space-between; height: 60px; 
            flex-shrink: 0; z-index: 50; box-shadow: 0 1px 2px rgba(0,0,0,0.2); 
        }
        .header-left { display: flex; align-items: center; gap: 10px; flex: 1; overflow: hidden; }
        .avatar-header { width: 40px; height: 40px; border-radius: 50%; }
        .chat-info h3 { margin: 0; font-size: 1rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .status-text { font-size: 0.75rem; color: var(--text-secondary); }
        .reconnect-btn { background: var(--danger); color: white; border: none; padding: 5px 10px; border-radius: 5px; font-size: 0.7rem; cursor: pointer; display: none; }

        #setup-panel { position: fixed; top: 0; left: 0; width: 100%; height: 100dvh; background: var(--bg-color); z-index: 1000; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; }
        .card { background: var(--header-bg); padding: 25px; border-radius: 15px; width: 100%; max-width: 350px; text-align: center; border: 1px solid var(--border); }
        input { width: 100%; padding: 12px; margin: 10px 0; background: var(--input-bg); border: none; color: var(--text-primary); border-radius: 8px; box-sizing: border-box; text-align: center; font-size: 1rem; }
        .btn { width: 100%; padding: 12px; margin-top: 10px; border: none; border-radius: 25px; font-weight: bold; font-size: 1rem; cursor: pointer; }
        .btn-green { background: var(--accent); color: white; }
        .btn-outline { background: transparent; border: 1px solid var(--accent); color: var(--accent); }

        #chat-area { flex: 1; overflow-y: auto; padding: 15px; background-size: 300px; position: relative; display: flex; flex-direction: column; gap: 5px; scroll-behavior: smooth; }
        #chat-area::before { content: ""; position: absolute; top:0; left:0; width:100%; height:100%; background: var(--bg-color); z-index: -1; pointer-events: none; }

        .msg-row { display: flex; width: 100%; margin-bottom: 2px; }
        .msg-bubble { max-width: 80%; padding: 6px 10px; border-radius: 10px; font-size: 0.95rem; position: relative; word-wrap: break-word; display: flex; flex-direction: column; }
        .me { justify-content: flex-end; } .me .msg-bubble { background: var(--bubble-me); border-top-right-radius: 0; }
        .them { justify-content: flex-start; } .them .msg-bubble { background: var(--bubble-them); border-top-left-radius: 0; }
        .sys { justify-content: center; margin: 10px 0; } .sys .msg-bubble { background: var(--input-bg); color: var(--text-secondary); font-size: 0.75rem; border-radius: 20px; text-align: center; }
        
        .sender-name { font-size: 0.75rem; font-weight: bold; margin-bottom: 2px; color: #fca103; }
        
        .meta-row { display: flex; align-items: center; justify-content: flex-end; gap: 5px; margin-top: 4px; }
        .timestamp { font-size: 0.65rem; color: var(--text-secondary); }
        .reply-icon { font-size: 0.7rem; color: var(--text-secondary); cursor: pointer; padding: 2px 5px; }
        
        .chat-img { max-width: 100%; border-radius: 6px; margin-top: 5px; cursor: pointer; }
        .chat-file { display: flex; align-items: center; gap: 10px; padding: 10px; background: rgba(0,0,0,0.1); border-radius: 5px; margin-top: 5px; text-decoration: none; color: var(--text-primary); border: 1px solid var(--border); }

        .reply-bar { background: var(--input-bg); padding: 8px 15px; border-left: 5px solid var(--accent); display: none; justify-content: space-between; align-items: center; border-radius: 8px 8px 0 0; }
        .reply-content { flex: 1; font-size: 0.8rem; }
        .reply-sender { color: var(--accent); font-weight: bold; font-size: 0.75rem; }
        .reply-text { color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 250px; }

        .footer-container { background: var(--header-bg); padding: 5px 10px; flex-shrink: 0; z-index: 50; padding-bottom: 10px; }
        .footer { display: flex; align-items: center; gap: 8px; }
        .input-box { flex: 1; background: var(--input-bg); border-radius: 20px; padding: 10px 15px; color: var(--text-primary); border: none; font-size: 1rem; max-height: 100px; outline: none; }
        .icon-btn { color: var(--text-secondary); font-size: 1.4rem; padding: 5px; cursor: pointer; }
        .send-btn { background: var(--accent); color: white; width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; }

        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 3000; justify-content: center; align-items: center; }
        .modal-box { background: var(--header-bg); padding: 20px; border-radius: 10px; width: 80%; max-width: 300px; text-align: center; }
        #upload-progress { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 5000; flex-direction: column; justify-content: center; align-items: center; color: white; }
        .spinner { border: 4px solid rgba(255,255,255,0.3); border-top: 4px solid var(--accent); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body data-theme="dark">

    <div id="upload-progress"><div class="spinner"></div><h3 id="upload-text">Processing...</h3></div>

    <div id="setup-panel">
        <div class="card">
            <h2 style="color:var(--accent); margin-bottom: 10px;">P2P Chat</h2>
            <img id="my-avatar-preview" src="" style="width:70px; height:70px; border-radius:50%; margin-bottom: 10px; border: 1px solid var(--accent);">
            <input type="text" id="username-input" placeholder="Username..." oninput="updateAvatar()">
            <input type="text" id="room-input" placeholder="Group ID...">
            <button onclick="startApp(true)" class="btn btn-green">Create / Host</button>
            <button onclick="startApp(false)" class="btn btn-outline">Join Group</button>
        </div>
    </div>

    <div class="header" id="main-header" style="display:none;">
        <div class="header-left">
            <i class="fas fa-arrow-left icon-btn" onclick="location.reload()"></i>
            <img id="group-avatar" class="avatar-header" src="">
            <div class="chat-info" style="margin-left: 10px;">
                <h3 id="chat-title">Group</h3>
                <span id="connection-status" class="status-text">Waiting...</span>
                <button id="reconnect-btn" class="reconnect-btn" onclick="retryConnection()">/ RECONNECT</button>
            </div>
        </div>
        <div>
            <i class="fas fa-sun icon-btn" onclick="toggleTheme()"></i>
            <i class="fas fa-user-plus icon-btn" onclick="showInvite()"></i>
        </div>
    </div>

    <div id="chat-area" style="display:none;"></div>

    <div class="footer-container" id="main-footer" style="display:none;">
        <div id="reply-bar" class="reply-bar">
            <div class="reply-content">
                <div id="reply-target-name" class="reply-sender"></div>
                <div id="reply-target-text" class="reply-text"></div>
            </div>
            <i class="fas fa-times" onclick="cancelReply()" style="padding:10px; color:var(--text-secondary); cursor:pointer;"></i>
        </div>

        <div class="footer">
            <i class="fas fa-plus icon-btn" onclick="document.getElementById('file-input').click()"></i>
            <input type="file" id="file-input" style="display:none" onchange="handleFileSelect()">
            <input type="text" id="msg-input" class="input-box" placeholder="Type message..." onkeypress="if(event.key==='Enter') sendChat()">
            <div class="send-btn" onclick="sendChat()"><i class="fas fa-paper-plane"></i></div>
        </div>
    </div>

    <div id="invite-modal" class="modal-overlay" onclick="if(event.target===this) this.style.display='none'">
        <div class="modal-box">
            <h3 style="color:var(--accent)">GROUP ID</h3>
            <input type="text" id="invite-id" readonly onclick="copyId(this)" style="width:100%; font-weight:bold; color:var(--accent); cursor:pointer; background: #111; border:none; padding:10px; text-align:center;">
        </div>
    </div>
    <div id="img-modal" class="modal-overlay" onclick="this.style.display='none'">
        <img id="img-full" style="max-width:95%; max-height:90%;">
    </div>

    <script>
        const peerConfig = {
            config: {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: "turn:global.relay.metered.ca:80", username: "e0c85ce62faba6edf920d892", credential: "g2dtUiurVlwXzt9d" }
                ]
            }
        };

        let peer, myName, roomId, isHost;
        let connections = [], hostConn = null, chatHistory = [];
        let replyTo = null;

        myName = localStorage.getItem('p2p_username') || "";
        document.getElementById('username-input').value = myName;
        updateAvatar();

        function updateAvatar() {
            const val = document.getElementById('username-input').value || "Guest";
            document.getElementById('my-avatar-preview').src = `https://api.dicebear.com/9.x/avataaars/svg?seed=${val}`;
        }

        function startApp(hostMode) {
            myName = document.getElementById('username-input').value || "Anon";
            localStorage.setItem('p2p_username', myName);
            roomId = document.getElementById('room-input').value.trim();
            if(!hostMode && !roomId) return alert("Input ID!");
            if(hostMode && !roomId) roomId = 'GROUP-' + Math.floor(Math.random()*9999);
            isHost = hostMode;
            initPeer();
        }

        function initPeer() {
            chatHistory = JSON.parse(localStorage.getItem('p2p_chat_' + roomId)) || [];
            document.getElementById('setup-panel').style.display = 'none';
            document.getElementById('main-header').style.display = 'flex';
            document.getElementById('main-footer').style.display = 'block';
            document.getElementById('chat-area').style.display = 'flex';
            document.getElementById('chat-title').innerText = roomId;
            document.getElementById('group-avatar').src = `https://api.dicebear.com/9.x/initials/svg?seed=${roomId}`;
            renderHistory();
            updateStatus("/ CONNECTING");
            
            peer = isHost ? new Peer(roomId, peerConfig) : new Peer(peerConfig);

            peer.on('open', (id) => {
                if(isHost) updateStatus("/ HOST ACTIVE");
                else connectToHost();
            });

            peer.on('connection', (conn) => {
                connections.push(conn);
                setupConn(conn);
                updateStatus("/ " + connections.length + " ONLINE");
            });

            peer.on('error', (err) => {
                updateStatus("/ DISCONNECTED");
                showReconnectBtn();
            });
        }

        function connectToHost() {
            updateStatus("/ SEARCHING HOST");
            if(hostConn) hostConn.close();
            hostConn = peer.connect(roomId, { metadata: { name: myName } });
            setupConn(hostConn);
        }

        function retryConnection() {
            document.getElementById('reconnect-btn').style.display = 'none';
            connectToHost();
        }

        function showReconnectBtn() {
            document.getElementById('reconnect-btn').style.display = 'inline-block';
            document.getElementById('connection-status').style.display = 'none';
        }

        function setupConn(conn) {
            conn.on('open', () => {
                updateStatus("/ CONNECTED");
                document.getElementById('reconnect-btn').style.display = 'none';
                document.getElementById('connection-status').style.display = 'block';
                if(!isHost) conn.send({ type: 'sys', text: myName + " joined" });
            });
            conn.on('data', (data) => {
                if(isHost) {
                    if(data.type !== 'sys') saveAndRender(data);
                    broadcast(data, conn.peer);
                } else {
                    saveAndRender(data);
                }
            });
            conn.on('close', () => {
                connections = connections.filter(c => c !== conn);
                updateStatus(isHost ? "/ " + connections.length + " ONLINE" : "/ DISCONNECTED");
                if(!isHost) showReconnectBtn();
            });
        }

        function broadcast(data, exclude) {
            connections.forEach(c => { if(c.peer !== exclude) c.send(data); });
        }

        function updateStatus(txt) {
            document.getElementById('connection-status').innerText = txt;
            document.getElementById('connection-status').style.display = 'block';
        }

        function sendChat() {
            const txt = document.getElementById('msg-input').value;
            if(!txt) return;
            const data = { 
                id: Date.now(), 
                type: 'text', text: txt, sender: myName, 
                time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}),
                replyTo: replyTo 
            };
            processSend(data);
            document.getElementById('msg-input').value = "";
            cancelReply();
        }

        function handleFileSelect() {
            const file = document.getElementById('file-input').files[0];
            if(!file || file.size > 5 * 1024 * 1024) return alert("Max 5MB!");
            document.getElementById('upload-progress').style.display = 'flex';
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = {
                    id: Date.now(),
                    type: file.type.startsWith('image/') ? 'image' : 'file',
                    content: e.target.result, fileName: file.name, sender: myName,
                    time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}),
                    replyTo: replyTo
                };
                processSend(data);
                document.getElementById('upload-progress').style.display = 'none';
                cancelReply();
            };
            reader.readAsDataURL(file);
        }

        function processSend(data) {
            saveAndRender(data, true);
            if(isHost) broadcast(data);
            else if(hostConn) hostConn.send(data);
        }

        function saveAndRender(data, isMe=false) {
            chatHistory.push({...data, isMe});
            localStorage.setItem('p2p_chat_' + roomId, JSON.stringify(chatHistory));
            renderMessage({...data, isMe});
        }

        function renderHistory() {
            document.getElementById('chat-area').innerHTML = '';
            chatHistory.forEach(msg => renderMessage(msg));
            scrollToBottom();
        }

        function renderMessage(data) {
            const div = document.createElement('div');
            const isMe = data.isMe || data.sender === myName;
            div.className = "msg-row " + (isMe ? "me" : "them");
            
            if(data.type === 'sys') {
                div.className = "msg-row sys";
                div.innerHTML = `<div class="msg-bubble">/ ${data.text}</div>`;
            } else {
                let content = `<span>${data.text}</span>`;
                if(data.type === 'image') content = `<img src="${data.content}" class="chat-img" onclick="viewImage(this.src)">`;
                if(data.type === 'file') content = `<a href="${data.content}" download="${data.fileName}" class="chat-file"><i class="fas fa-file"></i> / ${data.fileName}</a>`;

                let replyPreview = "";
                if(data.replyTo) {
                    replyPreview = `
                    <div style="background:rgba(0,0,0,0.1); border-left:3px solid var(--accent); padding:4px 6px; margin-bottom:5px; border-radius:4px; font-size:0.8rem;">
                        <div style="color:var(--accent); font-weight:bold; font-size:0.7rem;">/ ${data.replyTo.sender}</div>
                        <div style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                            ${data.replyTo.type==='image' ? '/ IMAGE' : (data.replyTo.type==='file' ? '/ FILE' : data.replyTo.text)}
                        </div>
                    </div>`;
                }

                div.innerHTML = `
                    <div class="msg-bubble">
                        ${replyPreview}
                        <span class="sender-name">${isMe ? '' : '/ ' + data.sender}</span>
                        ${content}
                        <div class="meta-row">
                            <span class="timestamp">${data.time}</span>
                            <i class="fas fa-reply reply-icon" onclick="initReply(${data.id})"></i>
                            ${isMe ? '<i class="fas fa-check"></i>' : ''}
                        </div>
                    </div>`;
            }
            document.getElementById('chat-area').appendChild(div);
            scrollToBottom();
        }

        function initReply(msgId) {
            const msg = chatHistory.find(m => m.id === msgId);
            if(!msg) return;
            replyTo = msg;
            document.getElementById('reply-bar').style.display = 'flex';
            document.getElementById('reply-target-name').innerText = "/ REPLY TO " + msg.sender;
            document.getElementById('reply-target-text').innerText = 
                msg.type === 'image' ? '/ IMAGE' : (msg.type === 'file' ? '/ FILE' : msg.text);
            document.getElementById('msg-input').focus();
        }

        function cancelReply() {
            replyTo = null;
            document.getElementById('reply-bar').style.display = 'none';
        }

        function scrollToBottom() {
            const area = document.getElementById('chat-area');
            setTimeout(() => area.scrollTop = area.scrollHeight, 100);
        }

        function toggleTheme() {
            const body = document.body;
            body.setAttribute('data-theme', body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark');
        }
        function showInvite() { 
            document.getElementById('invite-id').value = roomId; 
            document.getElementById('invite-modal').style.display = 'flex'; 
        }
        function copyId(el) { el.select(); document.execCommand("copy"); alert("ID Copied!"); }
        function viewImage(src) { 
            document.getElementById('img-full').src = src; 
            document.getElementById('img-modal').style.display = 'flex'; 
        }
    </script>
</body>
</html>
