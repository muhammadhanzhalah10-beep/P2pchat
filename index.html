<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Group Chat P2P (Serverless)</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { font-family: sans-serif; max-width: 600px; margin: 0 auto; padding: 10px; background: #121212; color: #eee; }
        .box { background: #1e1e1e; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #333; }
        input, button { width: 100%; padding: 10px; margin-top: 5px; box-sizing: border-box; border-radius: 5px; border: none; }
        input { background: #2c2c2c; color: #fff; border: 1px solid #444; }
        
        /* TOMBOL */
        .btn-host { background: #6200ea; color: white; font-weight: bold; } /* Ungu buat Host */
        .btn-join { background: #00c853; color: white; font-weight: bold; } /* Hijau buat Join */
        .btn-send { background: #2962ff; color: white; width: 20%; }
        
        #chat-area { display: none; }
        #msgs { height: 400px; overflow-y: auto; background: #000; border: 1px solid #333; padding: 10px; border-radius: 5px; display: flex; flex-direction: column; gap: 8px; }
        
        /* BUBBLE CHAT */
        .msg { padding: 8px 12px; border-radius: 10px; max-width: 85%; word-wrap: break-word; font-size: 0.9em; }
        .me { background: #2962ff; align-self: flex-end; color: #fff; border-bottom-right-radius: 0; }
        .them { background: #333; align-self: flex-start; color: #ddd; border-bottom-left-radius: 0; }
        .sender-name { font-size: 0.7em; color: #aaa; margin-bottom: 2px; }
        .sys { align-self: center; background: none; color: #666; font-size: 0.8em; font-style: italic; }
        
        .status-bar { padding: 5px; text-align: center; font-size: 0.8em; color: yellow; }
    </style>
</head>
<body>

    <h2 style="text-align:center;">ðŸ‘¥ Group Chat (Tanpa Server)</h2>
    <div id="status" class="status-bar">Mode Persiapan...</div>

    <div class="box" id="login-panel">
        <label>ðŸ‘¤ Nama Kamu:</label>
        <input type="text" id="username" placeholder="Misal: Si Kancil">
        
        <hr style="border-color:#333; margin: 15px 0;">
        
        <p style="font-size:0.9em; color:#aaa;">Pilih Peran:</p>
        <button onclick="startAsHost()" class="btn-host">JADI HOST (BUAT ROOM)</button>
        <p style="text-align:center; margin:5px;">â€” atau â€”</p>
        
        <input type="text" id="host-id-input" placeholder="Masukan ID Host disini...">
        <button onclick="joinRoom()" class="btn-join">GABUNG KE ROOM TEMAN</button>
    </div>

    <div class="box" id="host-panel" style="display:none; text-align:center;">
        <p>âœ… Room Berhasil Dibuat!</p>
        <p style="font-size:0.8em; color:#aaa;">Bagikan ID ini ke teman-temanmu:</p>
        <input type="text" id="my-room-id" readonly style="text-align:center; font-weight:bold; color:#00e676;" onclick="this.select()">
        <p style="font-size:0.8em; color:yellow;">Tunggu teman join...</p>
    </div>

    <div id="chat-area">
        <div id="msgs"></div>
        <div style="display: flex; gap: 5px; margin-top: 10px;">
            <input type="text" id="msg-input" placeholder="Ketik pesan..." onkeypress="if(event.key==='Enter') sendChat()">
            <button onclick="sendChat()" class="btn-send">âž¤</button>
        </div>
    </div>

    <script>
        // --- KONFIGURASI PEERJS (METERED AKUN LU) ---
        const peerConfig = {
            config: {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    {
                        urls: "turn:global.relay.metered.ca:80",
                        username: "e0c85ce62faba6edf920d892",
                        credential: "g2dtUiurVlwXzt9d"
                    }
                ]
            }
        };

        let peer = null;
        let myName = "";
        let connections = []; // List koneksi (buat Host simpan data peserta)
        let hostConnection = null; // Koneksi ke Host (buat Peserta)
        let iAmHost = false;

        // --- 1. JADI HOST (Bikin Room) ---
        function startAsHost() {
            myName = document.getElementById('username').value || "Host";
            
            // Bikin ID Random
            const roomId = 'room-' + Math.floor(Math.random() * 9999);
            
            peer = new Peer(roomId, peerConfig);
            iAmHost = true;

            peer.on('open', (id) => {
                document.getElementById('login-panel').style.display = 'none';
                document.getElementById('host-panel').style.display = 'block';
                document.getElementById('chat-area').style.display = 'block';
                document.getElementById('my-room-id').value = id;
                document.getElementById('status').innerText = "Status: Menunggu Peserta...";
                addMsg("Room dibuat! ID: " + id, "sys");
            });

            // Saat ada peserta masuk
            peer.on('connection', (conn) => {
                connections.push(conn); // Simpan peserta ke list
                setupConnection(conn);
                document.getElementById('status').innerText = "Status: " + connections.length + " Orang Online";
            });
        }

        // --- 2. JADI PESERTA (Gabung Room) ---
        function joinRoom() {
            myName = document.getElementById('username').value || "Peserta";
            const hostId = document.getElementById('host-id-input').value;
            
            if(!hostId) return alert("Masukan ID Host dulu!");

            peer = new Peer(peerConfig); // ID kita random aja
            iAmHost = false;

            peer.on('open', () => {
                // Langsung konek ke Host
                hostConnection = peer.connect(hostId, {
                    metadata: { name: myName } // Kirim nama kita ke Host
                });
                
                hostConnection.on('open', () => {
                    document.getElementById('login-panel').style.display = 'none';
                    document.getElementById('chat-area').style.display = 'block';
                    document.getElementById('status').innerText = "Status: Terhubung ke Host";
                    addMsg("Berhasil bergabung ke Group!", "sys");

                    // Listener kalau dapat pesan dari Host
                    hostConnection.on('data', (data) => handleData(data));
                });

                hostConnection.on('error', (err) => alert("Gagal konek: " + err));
            });
        }

        // --- 3. LOGIKA PESAN ---
        function setupConnection(conn) {
            conn.on('open', () => {
                // Kirim info siapa yang baru join ke semua orang
                broadcast({ type: 'sys', text: 'Seseorang bergabung!' });
            });

            conn.on('data', (data) => {
                // Host menerima pesan dari salah satu peserta
                if (iAmHost) {
                    // Tampilkan di layar Host
                    if(data.type === 'chat') addMsg(data.text, "them", data.sender);
                    
                    // TERUSKAN (Relay) ke peserta lain!
                    broadcast(data, conn.peer); // conn.peer = ID pengirim (biar ga dikirim balik ke dia)
                }
            });

            conn.on('close', () => {
                connections = connections.filter(c => c !== conn);
                broadcast({ type: 'sys', text: 'Seseorang keluar.' });
            });
        }

        // Fungsi Broadcast (Host menyebar pesan ke semua)
        function broadcast(data, excludeId = null) {
            connections.forEach(conn => {
                if (conn.peer !== excludeId) { // Jangan kirim balik ke pengirimnya
                    conn.send(data);
                }
            });
        }

        // Fungsi Menangani Data Masuk (di sisi Peserta)
        function handleData(data) {
            if (data.type === 'chat') {
                addMsg(data.text, "them", data.sender);
            } else if (data.type === 'sys') {
                addMsg(data.text, "sys");
            }
        }

        // Kirim Pesan dari UI
        function sendChat() {
            const input = document.getElementById('msg-input');
            const text = input.value;
            if (!text) return;

            // Tampilkan pesan sendiri
            addMsg(text, "me", myName);

            const msgPacket = { type: 'chat', text: text, sender: myName };

            if (iAmHost) {
                // Kalau Host: langsung broadcast ke semua anak buah
                broadcast(msgPacket);
            } else {
                // Kalau Peserta: kirim ke Host, biar Host yang sebar
                if(hostConnection) hostConnection.send(msgPacket);
            }

            input.value = "";
        }

        // UI Helper
        function addMsg(text, type, senderName = "") {
            const box = document.getElementById('msgs');
            const div = document.createElement('div');
            
            let html = "";
            if (type !== 'sys' && type !== 'me') {
                html += `<div class="sender-name">${senderName}</div>`;
            }
            html += text;
            
            div.innerHTML = html;
            div.className = "msg " + type;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }
    </script>
</body>
</html>
